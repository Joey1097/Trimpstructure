下面是一份详细完整的设计文档，面向单人 Web 端放置增量游戏（融合 Structure 的层级反馈与 Trimps 的资源-人口-战斗循环）。本设计包含产品目标、系统设计、数值与进度、UI/UX、前后端架构、数据持久化、安全与可运维性、开发里程碑与测试计划，便于落地。

一、产品概述
- 产品定位
  - 单人、可离线收益、轻战斗策略驱动的放置增量游戏。
  - 即时体验与长期进度并重，强调“层级系统互相乘算反馈”与“对位构筑”。
- 设计目标
  - 低门槛上手：首日内可见显著成长拐点。
  - 中期深度：通过世界节点、神器、地图机制带来策略与选择。
  - 长期可玩：循环内置多种玩法流派与高阶重置，配合挑战关持续更新。
- 目标用户与平台
  - 浏览器端（PC 优先，移动端适配）；离线玩家、增量游戏爱好者、轻策略玩家。

二、核心玩法与循环
- 总循环
  - 地图推进 → 获得蓝图/记忆/掉落 → 世界节点/神器强化 → 资源与战力跃迁 → 更高难地图 → Prestige 重置 → 跨层成长。
- 子循环
  - 资源与人口：人口→岗位→资源产出→建筑/研究→提升人口上限/效率。
  - 战斗与地图：装备/训练/神器→战斗力→节点推进→掉落→反哺。
  - 世界构筑：蓝图/记忆→世界节点→全局乘数/机制开关。
- 三大流派
  - 爆发推进流：短时高伤，适合限时与护盾图。
  - 稳定资源流：离线友好，稳定积累。
  - 控制破盾流：克制保护节点与特定抗性。

三、系统设计
A. 资源与人口系统
- 资源
  - 基础：木、石、铁、食、晶体（后续解锁稀有资源）。
  - 产出公式：每秒产出 = 人口×岗位效率×建筑效率×世界乘数×神器乘数×状态修正。
- 人口与岗位
  - 岗位：工人、建造、研究、士兵、探员（后续高阶岗位随系统解锁）。
  - 动态分配：支持手动滑杆和预设模板；后期自动化（阈值触发、比例维持）。
- 建筑与研究
  - 建筑：仓库、工坊、研究所、兵营、熔炉等，提供上限与效率乘数。
  - 研究：解锁系统、提升效率、开启机制（如破盾类型，自动化功能）。

B. 战斗与地图系统
- 战斗
  - 战力组成：基础攻击/生命/防御×（装备评分的根式增益）×世界/神器乘数。
  - 公式指引：避免指数爆裂，单系统内采用平方根/对数递减，跨系统保留乘算。
- 地图
  - 地图为节点/格子图，包含分支与保护节点。
  - 机制类型：
    - 护盾/抗性：仅特定伤害或资源能削减（引导对位构筑）。
    - 限时关：限定时间内清除若干节点（促进爆发流）。
    - 保护节点：需事先触发开关/破除相邻节点才能通行。
    - 环境惩罚：持续伤害/资源减产，要求特殊防护或神器。
  - 推进收益：蓝图、记忆、稀有材料、神器碎片、挑战货币。

C. 世界（World）与节点树
- 世界节点树
  - 结构：树状+若干分支专精（资源、战斗、控制、自动化四系）。
  - 类型：
    - 全局乘数：资源×、战斗×、离线×。
    - 机制开关：解锁破盾类型、保护节点探测、限时增益。
    - 自动化：岗位自动分配、装备自动升级阈值、神器预设切换条件。
- 资源消耗
  - 蓝图与记忆为主要货币，少量稀有材料作为门槛点；专精分支之间存在机会成本。

D. 神器（Artifacts）
- 槽位与套装
  - 早期2槽，中期3-4槽，后期5槽（通过进度解锁）。
  - 标签到位：爆发、持续、控制、经济；提供强力但互斥的加成。
- 获取与成长
  - 掉落碎片合成+升级。升级带来品质曲线与词条增强。
- 预设与切换
  - 支持两套预设（推图/资源），后期自动切换（基于地图/限时/资源阈值）。

E. Prestige 与挑战
- Prestige
  - 条件：达成若干章节终点或完成挑战里程碑。
  - 回报：传承点/记忆碎片，可在“传承面板”购买永续乘数/系统开关。
- 挑战关
  - 每月一张特殊规则地图，掉落外观与小幅专属词条（不破坏平衡）。
  - 可重复刷但收益递减，保留目标与回流动力。

四、数值与平衡指南
- 增长与边际
  - 单系统内递减：对数/根式；跨系统乘算：资源×世界×神器×装备。
  - 控墙策略：机制墙（护盾/路径/限时）优先，数值墙谨慎使用。
- TTK与节奏
  - 基准战斗时间 30-90秒/节点；地图 10-20 分钟；日常周期 1-2 小时显著进展。
- 重置经济
  - 早期重置频率高（解锁关键节点），中后期偏向开新分支、开放新地图层级。
- 离线收益
  - 上限约 8-12 小时满产（可通过世界节点延长），战斗推进离线仅模拟至最近安全节点，不推进地图分支。

五、UX/UI 设计
A. 信息架构
- 顶层导航
  - 概览（Dashboard）
  - 地图（Map）
  - 世界（World）
  - 神器（Artifacts）
  - 人口/管理（Population/Management）
  - 研究/建筑（Research/Buildings）
  - 传承（Prestige）
  - 日志/目标（Log/Goals）
  - 设置/存档（Settings/Save）
- 二级面板
  - 地图：节点图/路径、高亮机制、掉落预览、推荐构筑。
  - 世界：节点树、消耗预览、收益对比、分支建议。
  - 神器：背包、插槽、预设、词条明细、套装效果。
  - 人口/管理：岗位比例滑杆、模板保存、自动化条件编辑器。
  - 研究/建筑：队列、依赖关系、性价比提示（Top 3 推荐）。
  - 传承：回报预览、里程碑记录、重置影响提示。
  - 日志/目标：近期事件、短期目标（30分钟内）、长期目标（1-2天）、待办引导。
- 关键可视化
  - 乘算链路可展开查看：当前资源=人口×建筑×世界×神器（鼠标悬浮显示各段贡献）。
  - 地图机制图例：护盾、限时、保护节点一目了然；路径推荐用淡色虚线。
  - 收益对比条：当前升级带来的“预计推进时间缩短%”。

B. 交互与可用性
- 双预设一键切换：地图开始/结束时提示切换，或自动化触发。
- 拖拽排序：研究/建筑队列支持拖拽调整优先级。
- 自动化编辑器
  - 触发条件：资源≥X、地图为类型Y、战斗力评分≥Z。
  - 行为：切换预设、调整岗位比例、启用特定神器、开始/暂停研究队列。
- 辅助功能
  - 新手提示渐进式出现；可关闭或降噪。
  - 键盘快捷键：面板切换、预设切换、暂停/继续。
  - 色盲与高对比模式；数字展示支持“科学计数/缩写/自定义”。

C. 反馈与动效
- 升级/解锁采用短促动效与音效提示。
- 地图突破（破盾/限时过关）给独特视觉反馈与“战报摘要”。
- 离线归来时给“离线收益报告”，并推荐下一步操作。

六、前后端架构设计
A. 架构取向
- 单机优先、离线友好：全部核心逻辑在前端执行。
- 轻后端可选：云存档、匿名排行榜、活动配置下发。
- 模块化：数值核心与系统逻辑独立模块，统一被单元测试覆盖。

B. 前端
- 技术栈
  - React + TypeScript
  - 状态管理：Zustand 或 Redux（建议 Zustand 简洁方案）
  - 时间与 Tick：统一 GameLoop（1s tick，后台标签降低频率并依据时间差结算）
  - 大数：decimal.js/bignumber.js
- 模块划分
  - core/
    - formulas：统一的公式与常量（含平衡参数）
    - sim：战斗聚合模拟、离线结算
    - rng：随机源与种子
    - progression：解锁、阈值、里程碑逻辑
  - systems/
    - resources、population、buildings、research
    - world、artifacts、combat、maps、prestige
    - management（自动化与预设）
  - data/
    - 定义表（世界节点树、神器池、地图配置、研究与建筑表）
    - 版本化数据迁移器（data migrations）
  - ui/
    - 页面与组件、图标与可视化
  - save/
    - 序列化、压缩、校验、版本升级
- 性能与并发
  - Tick 批处理：将 UI 更新节流至每 250-500ms。
  - 计算复杂度：保持每 tick O(系统数)；战斗采用“波次聚合”，避免单兵碰撞。
  - 虚拟化列表与按需渲染（神器背包/日志）。

C. 后端（可选）
- 目标能力
  - 云存档：用户匿名ID（UUID v4）、OAuth 可选。
  - 活动与公告配置：JSON 下发，热更新。
  - 排行榜：匿名提交“挑战分数/用时”，每日/每月榜，简单防刷。
- 技术建议
  - 轻量服务：Node.js + Fastify/Express 或 Serverless（Cloudflare Workers / Vercel Functions）
  - 存储：KV/文档型（Firestore、DynamoDB、Cloudflare D1/Workers KV）
  - 鉴权：匿名 token + 签名，频率限制（IP + 用户ID）。
- API 粒度
  - /auth/anonymous
  - /save/upload, /save/download, /save/list
  - /events/config
  - /leaderboard/submit, /leaderboard/top
- 可观测性
  - 简易日志与错误上报（Sentry 等），仅匿名事件（关键里程碑、崩溃）。

七、数据持久化设计
A. 存档数据模型（前端）
- 存档结构
  - meta：version、timestamp、playtime、seed
  - player:
    - resources：各资源数量、上限、产出修正
    - population：总人口、岗位分配、模板、自动化规则
    - buildings：等级、队列、加成
    - research：已解锁、进度、队列
    - world：节点树状态、已购节点、分支点数
    - artifacts：库存、插槽、预设、词条与等级
    - combat：装备评分、训练等级、战斗系数
    - maps：当前地图ID、已通关节点、路径状态、掉落记录
    - prestige：传承点、里程碑、重置次数
    - challenges：进度、成就、时间记录
  - settings：UI 选项、显示偏好、键位、可达性设置
  - analytics_local：本地仅存放的匿名统计（不上传）
- 存储介质与策略
  - IndexedDB 为主，LocalStorage 存放最近一次保存的摘要与快速恢复指针。
  - 压缩：lz-string 或 pako；保存前校验与哈希摘要（防破损）。
  - 自动保存：每 30-60 秒与关键事件后立即保存；版本号递增。
  - 手动导出：Base64 字符串/JSON 文件；导入时进行 schema 验证与迁移。
- 版本化与迁移
  - 采用 semver 与迁移脚本：从 version X→Y 的逐步迁移器。
  - 迁移步骤：校验→备份→迁移→二次校验→落盘→提示日志。

B. 云存档（可选）
- 模型
  - userId、slotId、payload（加密+压缩）、checksum、updatedAt、clientVersion。
- 一致性策略
  - 客户端比较 updatedAt 与 checksum；发生冲突时允许用户选择保留本地或云端版本，并支持“合并部分模块”（如仅覆盖设置）。
- 安全
  - 传输层 HTTPS；payload 对称加密（密钥派生自 userId + server secret），防窥私。
  - 签名防篡改：HMAC(payload, server secret)。

八、安全与公平
- 反作弊（轻度）
  - 存档签名、回放校验（挑战提交时重算关键指标）。
  - 速率限制与异常检测（极端时间跳变、数值异常）。
- 隐私
  - 不收集个人身份信息；云存档匿名；可导出/删除数据（GDPR 友好）。
- 可靠性
  - 本地多副本（主存+备份），崩溃自动回滚到最近有效版本。

九、内容配置与LiveOps
- 数据驱动
  - 地图、世界树、神器、研究、建筑均用独立 JSON 表配置，支持热更新（仅数值与文本，不改公式）。
- 活动系统
  - 配置项：活动ID、地图规则覆盖、掉落权重、挑战货币、限时奖励。
- 本地化
  - 采用键值对资源文件；UI 文本与数值单位可替换；支持动态文案热替换。

十、可测试性与质量保障
- 单元测试
  - formulas、sim、progression、save/restore 全覆盖。
- 断言与卫语句
  - 核心 tick 路径对输入/输出范围进行断言，异常立刻降级处理并上报。
- 可视化测试
  - UI 组件 Storybook；关键图表快照测试。
- 平衡与体验测试
  - 自动化“机器人跑图”脚本，随机策略+目标策略对比输出 KPI：
    - 推进速度、TTK 分布、离线收益曲线、升级性价比稳定性。
- Beta 与灰度
  - 配置分流：10% 玩家打开新地图/新神器池；收集匿名指标。

十一、开发里程碑与分工
- M0 原型（1-2周）
  - 核心资源/人口/建筑/研究、地图最小推进、存档系统、基础UI。
- M1 核心闭环（2-3周）
  - 世界节点树V1、神器系统V1（2槽）、战斗聚合模拟、双预设、重置层1。
- M2 机制深化（3-4周）
  - 地图机制（护盾/限时/保护节点）、管理自动化V1、装备/训练、离线归来报告。
- M3 打磨与可用性（2-4周）
  - 目标/推荐面板、乘算链路可视化、设置与可达性、性能优化。
- M4 内容扩张与挑战（持续）
  - 新地图章节、世界分支、神器池扩展、月度挑战、云存档与榜单（可选）。

十二、文本与新手引导
- 新手体验（前30分钟）
  - 步骤式引导（资源→岗位→建筑→研究→地图首胜→世界首节点）。
  - 文案风格：简短行动导向，每次仅1-2个新概念。
- 里程碑文案
  - 破盾首次成功、限时首次通关、保护节点破除首次达成，配给简短策略提示与推荐构筑。
- 数据可视化文案
  - 乘算链路气泡说明，用通俗语言解释“为何升级有用”。
